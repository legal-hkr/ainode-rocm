server {
	listen 80;
	listen 443 ssl;

	ssl_certificate certs/ainode.crt;
	ssl_certificate_key certs/ainode.key;

	server_name kokoro-fastapi kokoro-fastapi.localdomain;

	proxy_buffering off;

	# Kokoro TTS (FastAPI)
	location / {
		resolver 127.0.0.11 valid=30s;
		proxy_bind $server_addr;
		proxy_pass http://ainode-kokoro-fastapi:8880/web/;

		# Add WebSocket support
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";

		# Timeouts for WebSocket connections
		proxy_read_timeout 60s;
		proxy_send_timeout 60s;
	}
}

map $http_upgrade $connection_upgrade {
	default upgrade;
	'' close;
}
